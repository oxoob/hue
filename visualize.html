<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

.axis text {
	color: #333;
	font: 10px sans-serif;
}

.axis path,
.axis line {
	fill: none;
	stroke: #666;
	stroke-width: 2;
	shape-rendering: crispEdges;
}	

.chart {
	background: #eee;
	border: 2px solid #ddd;
}	

</style>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
<svg class="chart"></svg>
<script>

var margin = 40;
// var width = 1520;
var width = 1280;
var height = 340;

var chart = d3.select(".chart")
		.attr("width", width)
		.attr("height", height) 
	.append("g")
		.attr("id","graph")
		.attr("transform", "translate(0, " + (height - margin) + ")");

var make_chart = function(data) {
	console.log("make_chart")
	var format = d3.time.format("%H:%M")
	var sun = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.sun); })
		.interpolate("linear");

	var l1_s = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light1_schedule); })
		.interpolate("linear");
	var l1_a = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light1_adjusted); })
		.interpolate("linear");
	var l1_m = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light1_smoothed); })
		.interpolate("linear");

	var l2_s = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light2_schedule); })
		.interpolate("linear");
	var l2_a = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light2_adjusted); })
		.interpolate("linear");
	var l2_m = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light2_smoothed); })
		.interpolate("linear");

	var l3_s = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light3_schedule); })
		.interpolate("linear");
	var l3_a = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light3_adjusted); })
		.interpolate("linear");
	var l3_m = d3.svg.line()
		.x(function(d) {return x(d.time); })
		.y(function(d) {return y(+d.light3_smoothed); })
		.interpolate("linear");

	var x = d3.scale.ordinal()
		.domain(data.map(function(d) {return d.time;}))
		.rangeBands([0 + margin, width-margin]);
	
	var y = d3.scale.linear()
		.domain([0,260])
		.range([height-margin,0 + margin]);

	var xax = d3.svg.axis()
		.scale(x)
		.tickValues(["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00",,"11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"])
		.orient("bottom");

	var yax = d3.svg.axis()
		.scale(y)
		.ticks(6)
		.orient("left");
	
	var graph = d3.select("#graph")
	
	var duration = 5000
	var delay    = 4000

	graph.append("path")
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",sun(data))
		.attr("stroke", "#fc2")
		.attr("fill", "none")

	graph.append("path")
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l1_s(data))
		.attr("stroke", "#2f2")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l1_a(data))
		.attr("stroke", "#1c1")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay * 2)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l1_m(data))
		.attr("stroke", "#090")
		.attr("fill", "none")

	graph.append("path")
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l2_s(data))
		.attr("stroke", "#22f")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l2_a(data))
		.attr("stroke", "#11c")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay * 2)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l2_m(data))
		.attr("stroke", "#009")
		.attr("fill", "none")

	graph.append("path")
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l3_s(data))
		.attr("stroke", "#f22")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l3_a(data))
		.attr("stroke", "#c11")
		.attr("fill", "none")
	    .transition()
	    	.delay(delay * 2)
		.duration(duration)
		.attr("transform", "translate(0," + (0 - height + margin) + ")")
		.attr("d",l3_m(data))
		.attr("stroke", "#900")
		.attr("fill", "none")

	graph.append("g")
		.attr("class","x axis")
		.call(xax);
			
	graph.append("g")	
		.attr("class","y axis")
		.attr("transform", "translate(" + margin + "," + (0 - height + margin) + ")")
		.call(yax);
		
};

var lights_tsv = function() {
	// var time_parse = d3.time.format("%H:%M").parse;
	d3.tsv("lights.tsv", function(error,lights) {
		data = lights.map(function (d) { 
			// return {"time": time_parse(d.time), "brightness": +d.brightness};
			return {"time": d.time, "sun": +d.sun, 
				"light1_schedule": d.light1_schedule, "light2_schedule": d.light2_schedule, "light3_schedule": d.light3_schedule,
				"light1_adjusted": d.light1_adjusted, "light2_adjusted": d.light2_adjusted, "light3_adjusted": d.light3_adjusted,
				"light1_smoothed": d.light1_smoothed, "light2_smoothed": d.light2_smoothed, "light3_smoothed": d.light3_smoothed
				};
		});
		make_chart(lights);
	});	
};	

lights_tsv();

</script>
</body>
</html>
